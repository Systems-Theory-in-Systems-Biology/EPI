    
from seedir import FakeDir, FakeFile
import seedir
import shutil
from epi import logger
# TODO: Import Path from pathlib?
import os
import numpy as np

class ResultManager():

    @staticmethod
    def getSliceName(slice: np.ndarray) -> str:
        return "Slice_" + "Q".join([str(i) for i in slice])

    @staticmethod
    def getSlicePath(self, slice: np.ndarray) -> str:
        sliceName = ResultManager.getSliceName(slice)
        return os.path.join("Applications", self.name, sliceName)

    @staticmethod
    def createApplicationFolderStructure(model, slices: list[np.ndarray]=None) -> None:
        """Creates the `Application` folder including subfolder where all simulation results
        are stored for this model. No files are deleted during this action.
        """
        
        if slices is None:
            slices = [np.arange(model.paramDim)]
        for slice in slices:
            ResultManager.createSliceFolderStructure(model, slice)

    @staticmethod
    def createSliceFolderStructure(model, slice: np.ndarray) -> None:
        applicationFolderStructure = (
            "Applications/ \n"
            "  - {modelName}/ \n"
            "    - {sliceName}/ \n"
            "       - DensityEvals/ \n"
            "       - Params/ \n"
            "       - SimResults/ \n"
        )
        path = "."
        structure = applicationFolderStructure

        def create(f, root):
            fpath = f.get_path()
            joined = os.path.join(root, fpath)
            if isinstance(f, FakeDir):
                try:
                    os.mkdir(joined)
                except FileExistsError:
                    logger.info(f"Directory `{joined}` already exists")
            elif isinstance(f, FakeFile):
                try:
                    with open(joined, "w"):
                        pass
                except FileExistsError:
                    logger.info(f"File `{joined}` already exists")
        
        sliceName = ResultManager.getSliceName(slice)
        fakeStructure = seedir.fakedir_fromstring(
            structure.format(modelName=model.name, sliceName=sliceName)
        )
        fakeStructure.realize = lambda path_arg: fakeStructure.walk_apply(
            create, root=path_arg
        )
        fakeStructure.realize(path)

    @staticmethod
    def deleteApplicationFolderStructure(model, slices) -> None:
        """Deletes the models `Applications` subfolder"""
        for slice in slices:
            try:
                ResultManager.deleteSliceFolderStructure(model, slice)
            except FileNotFoundError:
                logger.info(f"Folder structure for slice {slice} does not exist")

    @staticmethod
    def deleteSliceFolderStructure(model, slice: np.ndarray) -> None:
        path = ResultManager.getSlicePath(model, slice)
        shutil.rmtree(path)


    @staticmethod
    def getApplicationPath(model) -> str:
        """Returns the path to the simulation results folder, containing also intermediate results

        :return: path as string to the simulation folder
        :rtype: str
        """
        path = "Applications/" + model.name
        return path

    @staticmethod
    def loadSimResults(model, numBurnSamples: int, occurrence: int):
        """Load the files generated by the EPI algorithm through sampling

        :param model: Model from which the results will be loaded
        :type model: Model
        :param numBurnSamples: Ignore the first samples of each chain
        :type numBurnSamples: int
        :param occurrence: step of sampling from chains
        :type occurrence: int
        :return: _description_
        :rtype: _type_
        """
        results_path = ResultManager.getApplicationPath(model)

        densityEvals = np.loadtxt(
            results_path + "/OverallDensityEvals.csv",
            delimiter=",",
        )[numBurnSamples::occurrence]
        simResults = np.loadtxt(
            results_path + "/OverallSimResults.csv",
            delimiter=",",
            ndmin=2,
        )[numBurnSamples::occurrence, :]
        paramChain = np.loadtxt(
            results_path + "/OverallParams.csv",
            delimiter=",",
            ndmin=2,
        )[numBurnSamples::occurrence, :]
        return densityEvals, simResults, paramChain
